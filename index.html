<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ä¸­è‹±èªå–®è©æ‹¼å¯«ç‰¹è¨“ (AIå¢å¼·ç‰ˆ)</title>
    <link rel="manifest" href="manifest.json">

    <script>
        window.onerror = function (msg, url, line, col, error) {
            console.error('Error: ' + msg + '\nurl: ' + url + '\nline: ' + line);
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            touch-action: manipulation;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        @keyframes pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .anim-shake {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        .anim-pop {
            animation: pop 0.3s ease-out forwards;
        }

        .anim-bounce {
            animation: bounce 0.8s ease;
        }

        .anim-spin {
            animation: spin 1s linear infinite;
        }

        .anim-slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }

        .anim-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .mono-font {
            font-family: 'Courier New', Courier, monospace;
        }

        .input-focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
            border-color: #4299e1;
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
        .chat-bubble {
            max-width: 90%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .chat-user {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .chat-ai {
            background-color: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #e5e7eb;
        }

        .typing-dot {
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #6b7280;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .prose p {
            margin-bottom: 0.4em;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.2em;
        }

        .cursor-not-allowed {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .tab-active {
            color: #7c3aed;
            border-bottom: 2px solid #7c3aed;
            background-color: #f5f3ff;
        }

        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }

        .tab-inactive:hover {
            color: #374151;
            background-color: #f9fafb;
        }
    </style>
</head>

<body class="flex flex-col items-center p-4 text-gray-800">

    <canvas id="confetti-canvas"></canvas>

    <div class="w-full max-w-md flex flex-wrap justify-between items-center mb-4 px-1 gap-2">
        <div class="flex items-center gap-2 text-gray-600 bg-white/50 px-3 py-1 rounded-full backdrop-blur-sm">
            <i class="fas fa-book"></i>
            <span class="font-bold text-xs">å‰©é¤˜: <span id="words-left">0</span></span>
        </div>

        <div class="flex gap-2 flex-wrap justify-end">
            <button onclick="showApiKeyModal()"
                class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-bold border border-gray-300 shadow-sm active:scale-95 transition-transform"
                title="è¨­ç½® API Key">
                <i class="fas fa-key mr-1"></i>Key
            </button>

            <button onclick="document.getElementById('excel-input').click()"
                class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 shadow-sm active:scale-95 transition-transform">
                <i class="fas fa-file-excel mr-1"></i>å°å…¥
            </button>
            <input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden" />

            <button onclick="showCustomWordModal()"
                class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-bold border border-purple-200 shadow-sm active:scale-95 transition-transform">
                <i class="fas fa-edit mr-1"></i>ç®¡ç†
            </button>

            <button onclick="clearCustomWords()"
                class="bg-red-50 text-red-400 px-2 py-1 rounded-full text-xs border border-red-100" title="é‡ç½®ç‚ºé è¨­è©åº«">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>

    <div class="w-full max-w-md flex justify-end mb-2 px-1">
        <div
            class="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold border border-orange-200 shadow-sm">
            ğŸ”¥ Streak: <span id="streak-count">0</span>
        </div>
    </div>

    <div
        class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 relative mb-4 z-10">

        <div class="w-full bg-gray-100 h-1.5">
            <div id="progress-bar" class="bg-blue-500 h-1.5 transition-all duration-300" style="width: 0%"></div>
        </div>

        <div class="p-6 flex flex-col items-center gap-4">

            <div class="text-center w-full relative mt-2">
                <button id="play-audio-btn"
                    class="absolute right-0 top-0 text-blue-500 hover:text-blue-600 p-2 rounded-full hover:bg-blue-50 transition-colors"
                    title="é‡è½è®€éŸ³">
                    <i class="fas fa-volume-up text-xl"></i>
                </button>

                <p class="text-xs text-gray-400 uppercase tracking-wider font-bold mb-1">è«‹æ‹¼å¯«</p>

                <h2 id="chinese-word"
                    class="text-3xl font-bold text-gray-800 leading-tight min-h-[3rem] flex items-center justify-center px-4 break-words">
                    åŠ è¼‰ä¸­...
                </h2>

                <div class="flex items-center justify-center gap-2 mt-1">
                    <span id="ipa-text"
                        class="text-sm text-gray-500 font-sans bg-gray-100 px-2 py-0.5 rounded hidden"></span>
                    <span id="pos-tag" class="text-sm text-blue-500 font-mono bg-blue-50 px-2 py-0.5 rounded"></span>
                </div>
            </div>

            <div id="hint-container"
                class="w-full min-h-[1.5rem] px-2 flex flex-col items-center justify-center overflow-hidden">
                <div id="hint-text"
                    class="font-bold mono-font text-orange-500 transition-all min-h-[1.5rem] text-center break-words w-full">
                </div>
            </div>

            <div class="w-full relative" id="input-wrapper">
                <input type="text" id="user-input"
                    class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-xl bg-gray-50 input-focus-ring transition-colors mono-font placeholder-gray-300 shadow-inner"
                    placeholder="è¼¸å…¥è‹±æ–‡..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

                <div id="status-icon"
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-2xl hidden anim-pop">
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
            </div>

            <div class="w-full flex flex-col gap-3">
                <button id="check-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl text-lg shadow-md active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400">
                    <span>æäº¤ç­”æ¡ˆ</span>
                </button>

                <button id="skip-btn"
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3.5 rounded-xl shadow-md active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <span>è·³é</span> <i class="fas fa-forward"></i>
                </button>

                <button id="next-btn"
                    class="hidden w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-md active:scale-[0.98] transition-all flex items-center justify-center gap-2 anim-slide-up">
                    <span>ä¸‹ä¸€é¡Œ</span> <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <p id="message-text" class="text-center text-sm font-medium text-gray-500 h-5 transition-colors"></p>
        </div>

        <div id="confusion-card" class="bg-yellow-50 border-t border-yellow-100 p-4 hidden anim-fade-in">
            <div class="flex gap-3">
                <div class="text-yellow-500 text-xl pt-1"><i class="fas fa-lightbulb"></i></div>
                <div>
                    <h4 class="font-bold text-yellow-800 text-sm mb-1">çŸ¥è­˜é»ç­†è¨˜</h4>
                    <p id="confusion-text" class="text-sm text-yellow-700 leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <div
        class="w-full max-w-md bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden flex flex-col flex-1 min-h-[300px]">
        <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
            <div class="flex items-center gap-2 text-gray-700">
                <i class="fas fa-robot text-purple-500"></i>
                <span class="font-bold text-sm">DeepSeek åŠ©æ•™</span>
            </div>
            <span id="ai-status" class="text-xs text-gray-400 bg-gray-200 px-2 py-0.5 rounded">ç­‰å¾…ç­”é¡Œ</span>
        </div>

        <div class="flex border-b border-gray-200 text-sm font-bold select-none">
            <button id="tab-current-btn" class="flex-1 py-2 tab-active transition-colors">ç•¶å‰é¡Œç›®</button>
            <button id="tab-history-btn" class="flex-1 py-2 tab-inactive transition-colors">æ­·å²å°è©±</button>
        </div>

        <div id="chat-container" class="flex-1 overflow-hidden relative bg-white">
            <div id="chat-current" class="absolute inset-0 overflow-y-auto p-4 flex flex-col gap-2">
            </div>

            <div id="chat-history" class="absolute inset-0 overflow-y-auto p-4 flex flex-col gap-2 hidden bg-gray-50">
                <div class="text-center text-gray-400 text-xs mt-8">
                    <i class="fas fa-history mb-2 text-xl"></i>
                    <p>æš«ç„¡æ­·å²è¨˜éŒ„</p>
                </div>
            </div>
        </div>

        <div class="p-3 border-t bg-gray-50 flex gap-2 relative">
            <div id="ai-lock-mask"
                class="absolute inset-0 bg-gray-100/80 backdrop-blur-[1px] z-10 flex items-center justify-center text-gray-500 text-sm font-medium cursor-not-allowed">
                <i class="fas fa-lock mr-2"></i> è«‹å…ˆå®Œæˆç•¶å‰é¡Œç›®
            </div>

            <input type="text" id="ai-input"
                class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-purple-500 text-sm"
                placeholder="ä¾‹å¦‚ï¼šé€™å€‹è©çš„ä¾‹å¥ï¼Ÿ" disabled>
            <button id="send-ai-btn"
                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:bg-gray-400 transition-colors"
                disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div id="custom-word-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">è‡ªå®šç¾©è©åº«ç®¡ç†</h3>
                <button onclick="hideCustomWordModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-en-word" placeholder="è‹±æ–‡å–®è©"
                        class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="text" id="new-zh-word" placeholder="ä¸­æ–‡è§£é‡‹"
                        class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="text" id="new-pos-word" placeholder="è©æ€§"
                        class="w-20 border border-gray-300 rounded px-3 py-2 text-sm">
                </div>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="new-ipa-word" placeholder="éŸ³æ¨™"
                        class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="text" id="new-note-word" placeholder="å‚™è¨»"
                        class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm">
                </div>
                <button onclick="addCustomWord()"
                    class="w-full bg-blue-500 text-white py-2 rounded font-bold hover:bg-blue-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>æ·»åŠ æ–°å–®è©
                </button>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-bold text-gray-700 mb-2">ç•¶å‰è©åº«</h4>
                <div id="custom-word-list" class="max-h-60 overflow-y-auto space-y-2">
                </div>
            </div>

            <div class="flex gap-2 mt-4 pt-4 border-t">
                <button onclick="analyzeUserLevel()"
                    class="flex-1 bg-purple-500 text-white py-2 rounded font-bold hover:bg-purple-600 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i>æ™ºèƒ½åˆ†ææ°´å¹³
                </button>
                <button onclick="hideCustomWordModal()"
                    class="flex-1 bg-gray-500 text-white py-2 rounded font-bold hover:bg-gray-600 transition-colors">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <div id="api-key-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <div class="mb-4">
                <i class="fas fa-key text-4xl text-yellow-500 mb-2"></i>
                <h3 class="text-xl font-bold text-gray-800">è¨­ç½® AI å¯†é‘°</h3>
                <p class="text-sm text-gray-500 mt-1">è«‹è¼¸å…¥æ‚¨çš„ DeepSeek API Key ä»¥å•Ÿç”¨ AI åŠ©æ•™åŠŸèƒ½ã€‚</p>
            </div>

            <div class="mb-4 text-left">
                <label class="block text-gray-700 text-sm font-bold mb-2">API Key (sk-é–‹é ­)</label>
                <input type="password" id="api-key-input"
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500"
                    placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                <p class="text-xs text-gray-400 mt-2">
                    <i class="fas fa-shield-alt mr-1"></i>å®‰å…¨è²æ˜ï¼šKey åƒ…ä¿å­˜åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬åœ° (Local Storage)ï¼Œçµ•ä¸æœƒä¸Šå‚³è‡³ä»»ä½•ç¬¬ä¸‰æ–¹æœå‹™å™¨ã€‚
                </p>
            </div>

            <div class="flex gap-2">
                <button onclick="saveApiKey()"
                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">
                    ä¿å­˜ä¸¦å•Ÿç”¨
                </button>
                <button onclick="closeApiKeyModal()" class="px-4 py-2 text-gray-500 hover:text-gray-700">
                    æš«ä¸è¨­ç½®
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- é…ç½® ---
        const DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions";
        const LOCAL_STORAGE_KEY = "spelling_custom_vocab";
        const USER_STATS_KEY = "spelling_user_stats";
        const API_KEY_STORAGE_KEY = "user_deepseek_api_key";

        // --- åŸºç¡€è¯åº“ ---
        const baseVocabularyDB = [
            { en: ["debate", "argue"], zh: "çˆ­è¾¯ï¼›è¾¯è«–", pos: "v./n.", ipa: "/dÉªËˆbeÉªt/", note: "Argue å´é‡æ–¼å€‹äººçš„çˆ­åµæˆ–èªªç†ï¼ŒDebate å´é‡æ–¼å…¬é–‹çš„ã€æ­£å¼çš„è¾¯è«–ã€‚" },
            { en: "present", zh: "å±•ç¤ºï¼›ç¦®ç‰©ï¼›ç¾åœ¨çš„", pos: "v./n./adj.", ipa: "/Ëˆpreznt/", note: "æ³¨æ„ç™¼éŸ³ï¼šä½œ'ç¦®ç‰©'è¬›é‡éŸ³åœ¨å‰(PRE-sent)ï¼Œä½œ'å±•ç¤º'è¬›é‡éŸ³åœ¨å¾Œ(pre-SENT)ã€‚" },
            { en: "desert", zh: "æ²™æ¼ ï¼›æ‹‹æ£„", pos: "n./v.", ipa: "/ËˆdezÉ™t/", note: "æ˜“æ··ï¼šDessert (ç”œé») æœ‰å…©å€‹Sã€‚è¨˜æ†¶å£è¨£ï¼šç”œé»æƒ³åƒå…©ä»½(ss)ï¼Œæ²™æ¼ å¾ˆä¹¾åªæœ‰ä¸€å€‹(s)ã€‚" },
            { en: "identity", zh: "èº«ä»½ï¼›ç‰¹æ€§", pos: "n.", ipa: "/aÉªËˆdentÉ™ti/" },
            { en: "fluent", zh: "æµåˆ©çš„", pos: "adj.", ipa: "/ËˆfluËÉ™nt/", note: "å¸¸ç”¨æ­é…ï¼šbe fluent in English (è‹±èªæµåˆ©)ã€‚" },
            { en: "frequent", zh: "é »ç¹çš„", pos: "adj.", ipa: "/ËˆfriËkwÉ™nt/" },
            { en: "command", zh: "å‘½ä»¤ï¼›æŒ‡ä»¤ï¼›æŒæ¡", pos: "n./v.", ipa: "/kÉ™ËˆmÉ‘Ënd/", note: "Have a good command of... (ç²¾é€š...)" },
            { en: "recognize", zh: "è¾¨èªå‡ºï¼›æ‰¿èª", pos: "v.", ipa: "/ËˆrekÉ™É¡naÉªz/" },
            { en: "schedule", zh: "æ™‚é–“è¡¨ï¼›å®‰æ’", pos: "n./v.", ipa: "/ËˆÊƒedjuËl/", note: "è‹±å¼ç™¼éŸ³é¡ä¼¼'shed-ule'ï¼Œç¾å¼ç™¼éŸ³é¡ä¼¼'sked-ule'ã€‚" },
            { en: "reliable", zh: "å¯é çš„", pos: "adj.", ipa: "/rÉªËˆlaÉªÉ™bl/", note: "å‹•è©æ˜¯ Rely (rely on)ã€‚" },
            { en: "ambulance", zh: "æ•‘è­·è»Š", pos: "n.", ipa: "/ËˆÃ¦mbjÉ™lÉ™ns/" },
            { en: "appreciate", zh: "æ„Ÿæ¿€ï¼›æ¬£è³", pos: "v.", ipa: "/É™ËˆpriËÊƒieÉªt/", note: "I appreciate it. (æˆ‘å¾ˆæ„Ÿæ¿€)ã€‚å¾Œé¢ç›´æ¥æ¥äº‹ï¼Œä¸æ¥äººã€‚" },
            { en: "benefit", zh: "ç›Šè™•ï¼›ä½¿å—ç›Š", pos: "n./v.", ipa: "/ËˆbenÉªfÉªt/", note: "Benefit from... (å¾...ä¸­å—ç›Š)ã€‚" },
            { en: "ceremony", zh: "å…¸ç¦®ï¼›å„€å¼", pos: "n.", ipa: "/ËˆserÉ™mÉ™ni/" },
            { en: "colleague", zh: "åŒäº‹", pos: "n.", ipa: "/ËˆkÉ’liËÉ¡/", note: "College æ˜¯å¤§å­¸ï¼ŒColleague æ˜¯åŒäº‹ï¼Œæ³¨æ„æ‹¼å¯«å€åˆ¥ã€‚" },
            { en: "convenient", zh: "æ–¹ä¾¿çš„", pos: "adj.", ipa: "/kÉ™nËˆviËniÉ™nt/", note: "ä¸»èªé€šå¸¸æ˜¯ç‰©ï¼Œä¸èƒ½èªª 'I am convenient'ã€‚" },
            { en: "deadline", zh: "æˆªæ­¢æ—¥æœŸ", pos: "n.", ipa: "/ËˆdedlaÉªn/" },
            { en: "dilemma", zh: "é€²é€€å…©é›£çš„å¢ƒåœ°", pos: "n.", ipa: "/dÉªËˆlemÉ™/" },
            { en: "embarrassed", zh: "å°·å°¬çš„", pos: "adj.", ipa: "/ÉªmËˆbÃ¦rÉ™st/", note: "æ³¨æ„æ‹¼å¯«ï¼šé›™Ré›™S (rr, ss)ã€‚" },
            { en: "enthusiastic", zh: "ç†±æƒ…çš„", pos: "adj.", ipa: "/ÉªnËŒÎ¸juËziËˆÃ¦stÉªk/" },
            { en: "environment", zh: "ç’°å¢ƒ", pos: "n.", ipa: "/ÉªnËˆvaÉªrÉ™nmÉ™nt/" },
            { en: "focus", zh: "ç„¦é»ï¼›é›†ä¸­", pos: "v./n.", ipa: "/ËˆfÉ™ÊŠkÉ™s/", note: "Focus on... (é›†ä¸­æ³¨æ„åŠ›æ–¼...)" },
            { en: "generous", zh: "æ…·æ…¨çš„ï¼›å¤§æ–¹çš„", pos: "adj.", ipa: "/ËˆdÊ’enÉ™rÉ™s/" },
            { en: "graduate", zh: "ç•¢æ¥­ï¼›ç•¢æ¥­ç”Ÿ", pos: "v./n.", ipa: "/ËˆÉ¡rÃ¦dÊ’uÉ™t/" },
            { en: "immediately", zh: "ç«‹å³ï¼›é¦¬ä¸Š", pos: "adv.", ipa: "/ÉªËˆmiËdiÉ™tli/" },
            { en: "independent", zh: "ç¨ç«‹çš„", pos: "adj.", ipa: "/ËŒÉªndÉªËˆpendÉ™nt/" },
            { en: "kindergarten", zh: "å¹¼å…’åœ’", pos: "n.", ipa: "/ËˆkÉªndÉ™É¡É‘Ëtn/", note: "æºè‡ªå¾·èªï¼Œæ³¨æ„ä¸­é–“æ˜¯ 't' ä¸æ˜¯ 'd' (garTen)ã€‚" },
            { en: "luggage", zh: "è¡Œæ", pos: "n.", ipa: "/ËˆlÊŒÉ¡ÉªdÊ’/", note: "ä¸å¯æ•¸åè©ï¼Œä¸€ä»¶è¡Œæç”¨ a piece of luggageã€‚" },
            { en: "motivation", zh: "å‹•åŠ›ï¼›ç©æ¥µæ€§", pos: "n.", ipa: "/ËŒmÉ™ÊŠtÉªËˆveÉªÊƒn/" },
            { en: "nutrition", zh: "ç‡Ÿé¤Š", pos: "n.", ipa: "/njuËˆtrÉªÊƒn/" },
            { en: "opportunity", zh: "æ©Ÿæœƒ", pos: "n.", ipa: "/ËŒÉ’pÉ™ËˆtjuËnÉ™ti/" },
            { en: "participant", zh: "åƒèˆ‡è€…", pos: "n.", ipa: "/pÉ‘ËËˆtÉªsÉªpÉ™nt/" },
            { en: "phenomenon", zh: "ç¾è±¡", pos: "n.", ipa: "/fÉ™ËˆnÉ’mÉªnÉ™n/", note: "è¤‡æ•¸å½¢å¼æ˜¯ phenomenaã€‚" },
            { en: "recommend", zh: "æ¨è–¦", pos: "v.", ipa: "/ËŒrekÉ™Ëˆmend/", note: "é›™M (mm)ã€‚" },
            { en: "responsible", zh: "è² è²¬çš„", pos: "adj.", ipa: "/rÉªËˆspÉ’nsÉ™bl/", note: "Be responsible for..." },
            { en: "scenery", zh: "é¢¨æ™¯ï¼›æ™¯è‰²", pos: "n.", ipa: "/ËˆsiËnÉ™ri/", note: "ä¸å¯æ•¸åè©ã€‚View é€šå¸¸æŒ‡å¾é«˜è™•çœ‹çš„æ™¯è‰²ï¼ŒScenery æŒ‡è‡ªç„¶é¢¨å…‰æ•´é«”ã€‚" },
            { en: "surround", zh: "åŒ…åœï¼›ç’°ç¹", pos: "v.", ipa: "/sÉ™ËˆraÊŠnd/", note: "Surroundings (ç’°å¢ƒ/å‘¨åœäº‹ç‰©ï¼Œè¤‡æ•¸)ã€‚" },
            { en: "technology", zh: "ç§‘æŠ€", pos: "n.", ipa: "/tekËˆnÉ’lÉ™dÊ’i/" },
            { en: "tradition", zh: "å‚³çµ±", pos: "n.", ipa: "/trÉ™ËˆdÉªÊƒn/" },
            { en: "urgent", zh: "ç·Šæ€¥çš„", pos: "adj.", ipa: "/ËˆÉœËdÊ’É™nt/" },
            { en: "volunteer", zh: "å¿—é¡˜è€…", pos: "n./v.", ipa: "/ËŒvÉ’lÉ™nËˆtÉªÉ™/" }
        ];

        // å…¨å±€è¯åº“ (åˆå¹¶å)
        let vocabularyDB = [];

        // --- ç”¨æˆ·ç»Ÿè®¡å’Œæ°´å¹³åˆ†æ ---
        let userStats = {
            totalAnswered: 0,
            correctAnswers: 0,
            wrongAnswers: 0,
            skippedWords: 0,
            wordHistory: [], // è®°å½•æ¯ä¸ªå•è¯çš„ç­”é¢˜æƒ…å†µ
            level: "beginner", // beginner, intermediate, advanced
            weakAreas: [] // è–„å¼±çŸ¥è¯†ç‚¹
        };

        // --- æ¸¸æˆçŠ¶æ€ ---
        let gameData = {
            deck: [],
            currentWord: null,
            attempts: 0,
            streak: 0,
            isAnswered: false,
            revealedMask: null,
            lastWrongInput: ""
        };

        // --- DOM å…ƒç´  ---
        const els = {
            chinese: document.getElementById('chinese-word'),
            pos: document.getElementById('pos-tag'),
            ipa: document.getElementById('ipa-text'),
            input: document.getElementById('user-input'),
            hintText: document.getElementById('hint-text'),
            checkBtn: document.getElementById('check-btn'),
            skipBtn: document.getElementById('skip-btn'),
            nextBtn: document.getElementById('next-btn'),
            msg: document.getElementById('message-text'),
            streak: document.getElementById('streak-count'),
            wordsLeft: document.getElementById('words-left'),
            inputWrapper: document.getElementById('input-wrapper'),
            statusIcon: document.getElementById('status-icon'),
            progressBar: document.getElementById('progress-bar'),
            confusionCard: document.getElementById('confusion-card'),
            confusionText: document.getElementById('confusion-text'),
            playAudioBtn: document.getElementById('play-audio-btn'),
            excelInput: document.getElementById('excel-input'),
            aiInput: document.getElementById('ai-input'),
            sendAiBtn: document.getElementById('send-ai-btn'),
            chatCurrent: document.getElementById('chat-current'),
            chatHistory: document.getElementById('chat-history'),
            aiLockMask: document.getElementById('ai-lock-mask'),
            aiStatus: document.getElementById('ai-status'),
            tabCurrentBtn: document.getElementById('tab-current-btn'),
            tabHistoryBtn: document.getElementById('tab-history-btn'),
            // è‡ªå®šä¹‰è¯åº“æ¨¡æ€æ¡†å…ƒç´ 
            customWordModal: document.getElementById('custom-word-modal'),
            customWordList: document.getElementById('custom-word-list'),
            newEnWord: document.getElementById('new-en-word'),
            newZhWord: document.getElementById('new-zh-word'),
            newPosWord: document.getElementById('new-pos-word'),
            newIpaWord: document.getElementById('new-ipa-word'),
            newNoteWord: document.getElementById('new-note-word'),
            // API Key æ¨¡æ€æ¡†å…ƒç´ 
            apiKeyModal: document.getElementById('api-key-modal'),
            apiKeyInput: document.getElementById('api-key-input')
        };

        // --- éŸ³æ•ˆèˆ‡TTS ---
        let audioCtx;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.warn("Web Audio API not supported");
        }

        function playSound(type) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        function speakWord(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'en-US';
                u.rate = 0.9;
                window.speechSynthesis.speak(u);
            }
        }

        // --- API Key ç®¡ç†é€»è¾‘ ---
        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || "";
        }

        function showApiKeyModal() {
            els.apiKeyInput.value = getApiKey();
            els.apiKeyModal.classList.remove('hidden');
        }

        function closeApiKeyModal() {
            els.apiKeyModal.classList.add('hidden');
        }

        function saveApiKey() {
            const key = els.apiKeyInput.value.trim();
            if (key && !key.startsWith("sk-")) {
                alert("Key æ ¼å¼ä¼¼ä¹ä¸æ­£ç¢ºï¼Œé€šå¸¸ä»¥ sk- é–‹é ­");
                return;
            }
            if (!key) {
                if (confirm("ç¢ºå®šè¦æ¸…ç©º Key å—ï¼ŸAI åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚")) {
                    localStorage.removeItem(API_KEY_STORAGE_KEY);
                    closeApiKeyModal();
                    alert("Key å·²æ¸…é™¤");
                }
                return;
            }
            localStorage.setItem(API_KEY_STORAGE_KEY, key);
            closeApiKeyModal();
            alert("API Key å·²å®‰å…¨ä¿å­˜ï¼");

            // å¦‚æœä¹‹å‰æœ‰åˆ†æå¤±è´¥ï¼Œå¯ä»¥å°è¯•æç¤ºç”¨æˆ·ç°åœ¨å¯ä»¥ä½¿ç”¨äº†
            addChatBubble("API Key å·²è¨­ç½®ï¼Œä½ å¯ä»¥éš¨æ™‚å‘æˆ‘æå•äº†ï¼", "ai", true);
        }

        function checkApiKeyOnLoad() {
            if (!getApiKey()) {
                // é¦–æ¬¡åŠ è½½å¦‚æœæ²¡æœ‰Keyï¼Œå»¶è¿Ÿä¸€ç‚¹å¼¹å‡ºæç¤º
                setTimeout(showApiKeyModal, 1000);
            }
        }

        // --- Excel å°å…¥èˆ‡åˆä½µé‚è¼¯ ---
        function loadVocabulary() {
            const wordMap = new Map();
            baseVocabularyDB.forEach(item => {
                const key = (Array.isArray(item.en) ? item.en[0] : item.en).toLowerCase();
                wordMap.set(key, item);
            });
            const storedCustom = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedCustom) {
                try {
                    const customWords = JSON.parse(storedCustom);
                    customWords.forEach(item => {
                        const key = (Array.isArray(item.en) ? item.en[0] : item.en).toLowerCase();
                        wordMap.set(key, item);
                    });
                } catch (e) { console.error("Failed to parse local storage vocab", e); }
            }
            vocabularyDB = Array.from(wordMap.values());
            return vocabularyDB;
        }

        function clearCustomWords() {
            if (confirm("ç¢ºå®šè¦æ¸…é™¤å°å…¥çš„è‡ªå®šç¾©è©åº«ï¼Œåªä¿ç•™ç³»çµ±é è¨­è©å½™å—ï¼Ÿ")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                location.reload();
            }
        }

        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    const newWords = json.map(row => ({
                        en: row.en ? String(row.en).trim() : "",
                        zh: row.zh ? String(row.zh).trim() : "",
                        pos: row.pos ? String(row.pos).trim() : "",
                        ipa: row.ipa ? String(row.ipa).trim() : "",
                        note: row.note ? String(row.note).trim() : ""
                    })).filter(w => w.en && w.zh);

                    if (newWords.length === 0) {
                        alert("æœªåœ¨ Excel ä¸­æ‰¾åˆ°æœ‰æ•ˆæ•¸æ“šã€‚è«‹ç¢ºä¿è¡¨é ­åŒ…å« en, zh, pos");
                        return;
                    }
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(newWords));
                    alert(`æˆåŠŸå°å…¥ ${newWords.length} å€‹æ–°å–®è©ï¼é é¢å°‡åˆ·æ–°ã€‚`);
                    location.reload();
                } catch (err) {
                    console.error(err);
                    alert("è®€å– Excel å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼ã€‚");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function initGame() {
            try {
                loadVocabulary();
                loadUserStats();
                gameData.deck = [...vocabularyDB];
                updateDeckCount();
                loadNextWord();
                checkApiKeyOnLoad(); // æ£€æŸ¥ API Key

                // ç¶å®šäº‹ä»¶
                els.checkBtn.addEventListener('click', handleCheckSubmit);
                els.skipBtn.addEventListener('click', handleSkipWord);
                els.nextBtn.addEventListener('click', loadNextWord);
                els.playAudioBtn.addEventListener('click', () => {
                    if (gameData.currentWord) {
                        const wordToSpeak = Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en;
                        speakWord(wordToSpeak);
                    }
                });

                els.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!gameData.isAnswered) {
                            handleCheckSubmit();
                        }
                    }
                });

                els.input.addEventListener('input', () => {
                    if (!gameData.isAnswered) resetInputStyles();
                });

                els.excelInput.addEventListener('change', handleExcelUpload);
                els.sendAiBtn.addEventListener('click', sendAiMessage);
                els.aiInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendAiMessage(); });

                els.tabCurrentBtn.addEventListener('click', () => switchTab('current'));
                els.tabHistoryBtn.addEventListener('click', () => switchTab('history'));
            } catch (err) {
                alert("åˆå§‹åŒ–å¤±æ•—: " + err.message);
            }
        }

        function handleSkipWord() {
            if (gameData.isAnswered) return;
            gameData.isAnswered = true;
            userStats.skippedWords++;
            userStats.totalAnswered++;
            recordWordHistory('skipped');
            saveUserStats();

            const correctWord = Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en;
            els.hintText.innerHTML = `<span class="text-green-600 font-bold">${correctWord}</span>`;
            updateHintText(correctWord, correctWord.length, true);
            els.msg.textContent = "å·²è·³éæ­¤å–®è©";
            els.msg.className = "text-center text-sm font-medium text-yellow-600 h-5";
            speakWord(correctWord);
            els.input.disabled = true;
            showEndState(false, true);
        }

        function switchTab(tabName) {
            if (tabName === 'current') {
                els.chatCurrent.classList.remove('hidden');
                els.chatHistory.classList.add('hidden');
                els.tabCurrentBtn.classList.replace('tab-inactive', 'tab-active');
                els.tabHistoryBtn.classList.replace('tab-active', 'tab-inactive');
            } else {
                els.chatCurrent.classList.add('hidden');
                els.chatHistory.classList.remove('hidden');
                els.tabCurrentBtn.classList.replace('tab-active', 'tab-inactive');
                els.tabHistoryBtn.classList.replace('tab-inactive', 'tab-active');
            }
        }

        function updateDeckCount() {
            els.wordsLeft.textContent = gameData.deck.length;
        }

        function loadNextWord() {
            if (gameData.deck.length === 0) {
                alert("å¤ªæ£’äº†ï¼ä½ å·²ç¶“ç·´å®Œäº†æ‰€æœ‰å–®è©ã€‚å³å°‡é–‹å§‹æ–°çš„ä¸€è¼ªï¼");
                gameData.deck = [...vocabularyDB];
                updateDeckCount();
            }

            archiveCurrentChat();

            const randIndex = Math.floor(Math.random() * gameData.deck.length);
            gameData.currentWord = gameData.deck[randIndex];
            gameData.deckIndex = randIndex;

            gameData.attempts = 0;
            gameData.isAnswered = false;
            gameData.revealedMask = null;
            gameData.lastWrongInput = "";

            els.chinese.textContent = gameData.currentWord.zh;
            els.pos.textContent = gameData.currentWord.pos;

            if (gameData.currentWord.ipa) {
                els.ipa.textContent = gameData.currentWord.ipa;
                els.ipa.classList.remove('hidden');
            } else {
                els.ipa.classList.add('hidden');
            }

            els.input.value = '';
            els.input.disabled = false;
            els.input.focus();

            els.hintText.textContent = '';
            els.hintText.className = "font-bold mono-font text-orange-500 transition-all min-h-[1.5rem] text-center break-words w-full";

            els.msg.textContent = '';
            els.confusionCard.classList.add('hidden');

            els.checkBtn.classList.remove('hidden');
            els.checkBtn.disabled = false;
            els.skipBtn.classList.remove('hidden');
            els.nextBtn.classList.add('hidden');

            resetInputStyles();
            els.statusIcon.classList.add('hidden');

            lockAiChat();
            initCurrentChatGreeting();
            switchTab('current');

            els.progressBar.style.width = '0%';
            setTimeout(() => els.progressBar.style.width = '100%', 100);

            setTimeout(() => {
                const wordToSpeak = Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en;
                speakWord(wordToSpeak);
            }, 500);
        }

        function resetInputStyles() {
            els.input.classList.remove('border-red-500', 'bg-red-50', 'text-red-600', 'border-green-500', 'bg-green-50', 'text-green-700');
            els.input.classList.add('border-gray-300', 'bg-gray-50');
            els.msg.textContent = "";
        }

        function handleCheckSubmit() {
            if (gameData.isAnswered) return;

            const userVal = els.input.value.trim().toLowerCase();
            if (!userVal) {
                shakeInput();
                return;
            }

            const correctAnswers = Array.isArray(gameData.currentWord.en)
                ? gameData.currentWord.en.map(w => w.toLowerCase())
                : [gameData.currentWord.en.toLowerCase()];

            const primaryAnswer = correctAnswers[0];

            if (correctAnswers.includes(userVal)) {
                handleCorrect(userVal);
            } else {
                gameData.lastWrongInput = userVal;
                handleWrong(userVal, primaryAnswer);
            }
        }

        function handleCorrect(userAnswer) {
            gameData.isAnswered = true;
            gameData.streak++;
            els.streak.textContent = gameData.streak;

            gameData.deck.splice(gameData.deckIndex, 1);
            updateDeckCount();

            userStats.correctAnswers++;
            userStats.totalAnswered++;
            recordWordHistory('correct');
            saveUserStats();

            playSound('correct');
            fireConfetti();

            els.input.classList.remove('border-gray-300', 'bg-gray-50');
            els.input.classList.add('border-green-500', 'bg-green-50', 'text-green-700', 'anim-bounce');
            els.input.disabled = true;
            els.statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
            els.statusIcon.classList.remove('hidden');

            els.msg.textContent = "Excellent! æ‹¼å¯«æ­£ç¢º ğŸ‰";
            els.msg.className = "text-center text-sm font-medium text-green-600 h-5";

            showEndState(true);
        }

        function handleWrong(userVal, correctVal) {
            gameData.attempts++;
            gameData.streak = 0;
            els.streak.textContent = 0;
            playSound('wrong');
            shakeInput();

            els.input.classList.remove('border-gray-300', 'bg-gray-50');
            els.input.classList.add('border-red-500', 'bg-red-50', 'text-red-600');
            els.msg.className = "text-center text-sm font-medium text-red-500 h-5";

            if (gameData.attempts === 1) {
                els.msg.textContent = "ä¸å°å“¦ï¼Œå†è©¦ä¸€æ¬¡";
                els.input.value = '';
                els.input.focus();
            } else if (gameData.attempts === 2) {
                if (!gameData.revealedMask) {
                    gameData.revealedMask = generateRandomMask(correctVal);
                }
                updateHintText(gameData.revealedMask, correctVal.length);
                els.msg.textContent = "æç¤ºï¼šæ ¹æ“šéª¨æ¶å¡«ç©º";
                els.input.value = '';
                els.input.focus();
            } else {
                els.hintText.innerHTML = `<span class="text-green-600 font-bold">${correctVal}</span>`;
                updateHintText(correctVal, correctVal.length, true);
                els.msg.textContent = "ä¸Šæ–¹ç‚ºæ­£ç¢ºæ‹¼å¯«ï¼Œè«‹å°æ¯”ä½ çš„ç­”æ¡ˆ";
                gameData.isAnswered = true;

                userStats.wrongAnswers++;
                userStats.totalAnswered++;
                recordWordHistory('wrong');
                saveUserStats();
                speakWord(correctVal);
                els.input.disabled = true;
                showEndState(false);
            }
        }

        function updateHintText(text, length, isHtml = false) {
            let baseClass = "font-bold mono-font transition-all min-h-[1.5rem] text-center break-words w-full flex items-center justify-center";
            let colorClass = "text-orange-500";
            if (isHtml) colorClass = "";
            if (length > 10) {
                els.hintText.className = `${baseClass} ${colorClass} text-lg tracking-normal`;
            } else {
                els.hintText.className = `${baseClass} ${colorClass} text-xl tracking-[0.3em]`;
            }
            if (!isHtml) {
                els.hintText.textContent = text;
            }
        }

        function showEndState(isSuccess, isSkipped = false) {
            els.checkBtn.disabled = true;
            els.skipBtn.classList.add('hidden');
            els.nextBtn.classList.remove('hidden');

            if (gameData.currentWord.note) {
                els.confusionText.innerHTML = gameData.currentWord.note;
                els.confusionCard.classList.remove('hidden');
            }

            unlockAiChat();

            if (!isSuccess && !isSkipped && gameData.lastWrongInput) {
                autoAnalyzeError(gameData.lastWrongInput, Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en);
            }
        }

        function shakeInput() {
            els.inputWrapper.classList.remove('anim-shake');
            void els.inputWrapper.offsetWidth;
            els.inputWrapper.classList.add('anim-shake');
        }

        function generateRandomMask(word) {
            let res = "";
            for (let i = 0; i < word.length; i++) {
                let show = (i === 0 || i === word.length - 1) ? (Math.random() > 0.3) : (Math.random() > 0.6);
                if (word.length <= 4 && i === 0) show = true;
                res += show ? word[i] : "_";
                res += " ";
            }
            return res.trim();
        }

        function loadUserStats() {
            const storedStats = localStorage.getItem(USER_STATS_KEY);
            if (storedStats) {
                try {
                    userStats = JSON.parse(storedStats);
                } catch (e) { console.error("Failed to parse user stats", e); }
            }
        }

        function saveUserStats() {
            localStorage.setItem(USER_STATS_KEY, JSON.stringify(userStats));
        }

        function recordWordHistory(result) {
            const word = Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en;
            userStats.wordHistory.push({
                word: word,
                result: result,
                timestamp: new Date().toISOString(),
                attempts: gameData.attempts
            });
            if (userStats.wordHistory.length > 100) {
                userStats.wordHistory = userStats.wordHistory.slice(-100);
            }
        }

        function showCustomWordModal() {
            els.customWordModal.classList.remove('hidden');
            renderCustomWordList();
        }

        function hideCustomWordModal() {
            els.customWordModal.classList.add('hidden');
        }

        function renderCustomWordList() {
            const customWords = getCustomWords();
            els.customWordList.innerHTML = '';
            if (customWords.length === 0) {
                els.customWordList.innerHTML = '<p class="text-gray-500 text-center py-4">æš«ç„¡è‡ªå®šç¾©è©åº«</p>';
                return;
            }
            customWords.forEach((word, index) => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'bg-gray-50 p-3 rounded border border-gray-200';
                wordDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="font-bold text-gray-800">${word.en}</div>
                            <div class="text-sm text-gray-600">${word.zh}</div>
                            ${word.pos ? `<span class="text-xs text-blue-500 bg-blue-50 px-2 py-0.5 rounded">${word.pos}</span>` : ''}
                            ${word.ipa ? `<span class="text-xs text-gray-500 ml-2">${word.ipa}</span>` : ''}
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editCustomWord(${index})" class="text-blue-500 hover:text-blue-700 p-1"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteCustomWord(${index})" class="text-red-500 hover:text-red-700 p-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    ${word.note ? `<div class="text-xs text-gray-500 mt-1">${word.note}</div>` : ''}
                `;
                els.customWordList.appendChild(wordDiv);
            });
        }

        function getCustomWords() {
            const storedCustom = localStorage.getItem(LOCAL_STORAGE_KEY);
            return storedCustom ? JSON.parse(storedCustom) : [];
        }

        function saveCustomWords(words) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(words));
            loadVocabulary();
            gameData.deck = [...vocabularyDB];
            updateDeckCount();
        }

        function addCustomWord() {
            const en = els.newEnWord.value.trim();
            const zh = els.newZhWord.value.trim();
            const pos = els.newPosWord.value.trim();
            const ipa = els.newIpaWord.value.trim();
            const note = els.newNoteWord.value.trim();

            if (!en || !zh) {
                alert("è«‹å¡«å¯«è‹±æ–‡å–®è©å’Œä¸­æ–‡è§£é‡‹");
                return;
            }
            const customWords = getCustomWords();
            customWords.push({ en, zh, pos, ipa, note });
            saveCustomWords(customWords);

            els.newEnWord.value = ''; els.newZhWord.value = ''; els.newPosWord.value = ''; els.newIpaWord.value = ''; els.newNoteWord.value = '';
            renderCustomWordList();
        }

        function editCustomWord(index) {
            const customWords = getCustomWords();
            const word = customWords[index];
            els.newEnWord.value = word.en;
            els.newZhWord.value = word.zh;
            els.newPosWord.value = word.pos || '';
            els.newIpaWord.value = word.ipa || '';
            els.newNoteWord.value = word.note || '';
            deleteCustomWord(index);
        }

        function deleteCustomWord(index) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å–®è©å—ï¼Ÿ")) return;
            const customWords = getCustomWords();
            customWords.splice(index, 1);
            saveCustomWords(customWords);
            renderCustomWordList();
        }

        async function analyzeUserLevel() {
            const apiKey = getApiKey();
            if (!apiKey) {
                showApiKeyModal();
                alert("è«‹å…ˆè¨­ç½® API Key");
                return;
            }

            const customWords = getCustomWords();
            const analysisPrompt = `
è«‹åˆ†æä»¥ä¸‹è‹±èªå­¸ç¿’è€…çš„æ°´å¹³ä¸¦çµ¦å‡ºå»ºè­°ï¼š
å­¸ç¿’çµ±è¨ˆï¼š
- ç¸½ç­”é¡Œæ•¸ï¼š${userStats.totalAnswered}
- æ­£ç¢ºç­”æ¡ˆï¼š${userStats.correctAnswers}
- éŒ¯èª¤ç­”æ¡ˆï¼š${userStats.wrongAnswers}
- è·³éå–®è©ï¼š${userStats.skippedWords}
- æ­£ç¢ºç‡ï¼š${userStats.totalAnswered > 0 ? Math.round((userStats.correctAnswers / userStats.totalAnswered) * 100) : 0}%
è‡ªå®šç¾©è©åº«è©å½™ï¼ˆ${customWords.length}å€‹ï¼‰ï¼š
${customWords.map(w => `- ${w.en} (${w.zh})`).join('\n')}
è«‹æ ¹æ“šä»¥ä¸Šä¿¡æ¯ï¼š
1. è©•ä¼°ç”¨æˆ¶çš„è‹±èªæ°´å¹³ï¼ˆåˆç´š/ä¸­ç´š/é«˜ç´šï¼‰
2. åˆ†æç”¨æˆ¶çš„è–„å¼±ç’°ç¯€
3. çµ¦å‡ºå­¸ç¿’å»ºè­°
4. æ¨è–¦ä¸‹ä¸€æ­¥å­¸ç¿’çš„è©å½™ä¸»é¡Œ
è«‹ç”¨ä¸­æ–‡å›ç­”ï¼Œç°¡æ½”æ˜äº†ã€‚`;

            addChatBubble('æ­£åœ¨åˆ†ææ‚¨çš„å­¸ç¿’æ•¸æ“š...', 'ai', true);
            hideCustomWordModal();

            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: analysisPrompt }],
                        stream: false
                    })
                });

                if (!response.ok) throw new Error("Network error or invalid key");
                const data = await response.json();

                const responseText = data.choices[0].message.content;
                if (responseText.includes('é«˜ç´š')) userStats.level = 'advanced';
                else if (responseText.includes('ä¸­ç´š')) userStats.level = 'intermediate';
                else userStats.level = 'beginner';
                saveUserStats();

                addChatBubble(responseText, 'ai');
            } catch (e) {
                console.error(e);
                addChatBubble("åˆ†æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ– API Key æ˜¯å¦æ­£ç¢ºã€‚", 'ai');
            }
        }

        function initCurrentChatGreeting() {
            els.chatCurrent.innerHTML = `
                <div class="chat-bubble chat-ai prose">
                    ä½ å¥½ï¼è«‹å…ˆå®Œæˆå–®è©æŒ‘æˆ°ã€‚<br>ç­”å®Œå¾Œå¦‚æœæœ‰ç–‘å•ï¼Œæˆ‘æœƒéš¨æ™‚è§£ç­”ã€‚
                </div>
            `;
        }

        function archiveCurrentChat() {
            const bubbles = els.chatCurrent.querySelectorAll('.chat-bubble');
            if (bubbles.length > 0) {
                const emptyMsg = els.chatHistory.querySelector('.text-center');
                if (emptyMsg) emptyMsg.remove();
                const wordTitle = Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en;
                const archiveBlock = document.createElement('div');
                archiveBlock.className = "bg-white p-3 rounded-lg shadow-sm border border-gray-100 mb-4";
                archiveBlock.innerHTML = `<div class="text-xs font-bold text-gray-400 mb-2 border-b pb-1">å–®è©: ${wordTitle} (${gameData.currentWord.zh})</div>`;
                bubbles.forEach(b => {
                    const clone = b.cloneNode(true);
                    clone.style.fontSize = "0.85rem";
                    archiveBlock.appendChild(clone);
                });
                els.chatHistory.insertBefore(archiveBlock, els.chatHistory.firstChild);
            }
            els.chatCurrent.innerHTML = '';
        }

        function lockAiChat() {
            els.aiLockMask.classList.remove('hidden');
            els.aiInput.disabled = true;
            els.sendAiBtn.disabled = true;
            els.aiStatus.textContent = "ç­‰å¾…ç­”é¡Œ";
            els.aiStatus.className = "text-xs text-gray-400 bg-gray-200 px-2 py-0.5 rounded";
        }

        function unlockAiChat() {
            els.aiLockMask.classList.add('hidden');
            els.aiInput.disabled = false;
            els.sendAiBtn.disabled = false;
            els.aiStatus.textContent = "å¯æå•";
            els.aiStatus.className = "text-xs text-green-700 bg-green-100 px-2 py-0.5 rounded font-bold";
            els.chatCurrent.scrollTop = els.chatCurrent.scrollHeight;
        }

        async function autoAnalyzeError(wrongInput, correctWord) {
            const apiKey = getApiKey();
            if (!apiKey) return; // å¦‚æœæ²¡keyï¼Œé»˜é»˜è·³è¿‡è‡ªåŠ¨åˆ†æ

            const prompt = `å­¸ç”Ÿåœ¨è½å¯«ç·´ç¿’ä¸­æŠŠå–®è© "${correctWord}" æ‹¼å¯«æˆäº† "${wrongInput}"ã€‚è«‹ç°¡è¦åˆ†æéŒ¯èª¤åŸå› ï¼ˆä¾‹å¦‚ï¼šæ‹¼å¯«ç­†èª¤ã€ç™¼éŸ³æ··æ·†ã€è©æ€§éŒ¯èª¤ç­‰ï¼‰ï¼Œä¸¦çµ¦å‡ºä¸€é»è¨˜æ†¶å»ºè­°ã€‚è«‹ç”¨è¦ªåˆ‡çš„å£å»ï¼Œ50å­—ä»¥å…§ã€‚`;

            addChatBubble('æ­£åœ¨åˆ†æä½ çš„éŒ¯èª¤...', 'ai', true);

            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "user", content: prompt }],
                        stream: false
                    })
                });

                if (!response.ok) throw new Error("Net err");
                const data = await response.json();

                els.chatCurrent.lastElementChild.remove();
                addChatBubble(data.choices[0].message.content, 'ai');
            } catch (e) {
                console.error(e);
                els.chatCurrent.lastElementChild.remove();
            }
        }

        async function sendAiMessage() {
            const apiKey = getApiKey();
            if (!apiKey) {
                showApiKeyModal();
                return;
            }

            const text = els.aiInput.value.trim();
            if (!text) return;

            addChatBubble(text, 'user');
            els.aiInput.value = '';

            const loadingId = 'loading-' + Date.now();
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble chat-ai';
            loadingBubble.id = loadingId;
            loadingBubble.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            els.chatCurrent.appendChild(loadingBubble);
            els.chatCurrent.scrollTop = els.chatCurrent.scrollHeight;

            const currentWordStr = Array.isArray(gameData.currentWord.en) ? gameData.currentWord.en[0] : gameData.currentWord.en;
            const systemPrompt = `ä½ æ˜¯ä¸€ä½é«˜ä¸­è‹±èªåŠ©æ•™ã€‚ç•¶å‰å–®è©: "${currentWordStr}" (${gameData.currentWord.zh})ã€‚
            è«‹å›ç­”å­¸ç”Ÿçš„å•é¡Œã€‚ç°¡æ½”ã€åœ°é“ã€‚`;

            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ],
                        stream: false
                    })
                });

                if (!response.ok) throw new Error("Net err");
                const data = await response.json();
                document.getElementById(loadingId).remove();
                addChatBubble(data.choices[0].message.content, 'ai');
            } catch (error) {
                document.getElementById(loadingId).remove();
                addChatBubble("ç¶²çµ¡é–‹å°å·®äº†ï¼Œæˆ–è€… API Key ç„¡æ•ˆã€‚", 'ai');
            }
        }

        function addChatBubble(text, role, isSystem = false) {
            const div = document.createElement('div');
            div.className = `chat-bubble chat-${role} prose`;
            if (role === 'ai') div.innerHTML = isSystem ? text : marked.parse(text);
            else div.textContent = text;
            els.chatCurrent.appendChild(div);
            els.chatCurrent.scrollTop = els.chatCurrent.scrollHeight;
        }

        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    r: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vx: (Math.random() - 0.5) * 12,
                    vy: (Math.random() - 0.5) * 12,
                    gravity: 0.2,
                    alpha: 1
                });
            }

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if (p.alpha > 0) {
                        p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.alpha -= 0.02;
                        ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color;
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
                        active = true;
                    }
                });
                if (active) requestAnimationFrame(render);
            }
            render();
        }

        window.onload = initGame;
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registered', reg))
                    .catch(err => console.error('Service Worker registration failed', err));
            });
        }
    </script>
</body>

</html>